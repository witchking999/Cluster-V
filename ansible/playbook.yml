---
- name: network mounts
  hosts: 
    - lan-client-server
    - lan-client
    - cheese
  vars:
    head_node_ip: "{{ lookup('env', 'HEAD_NODE_IP') | default('192.168.128.111', true) }}"
    nfs_server: "{{ lookup('env', 'NFS_SERVER') | default(head_node_ip, true) }}"
    nfs_exports:
      - { remote: "{{ nfs_server }}:/mnt/pool0/share", mount: "/home/shared", fstype: "nfs4", opts: "_netdev,auto" }
      - { remote: "{{ nfs_server }}:/mnt/pool1/media/TV", mount: "/home/media/TV", fstype: "nfs4", opts: "_netdev,auto" }
      - { remote: "{{ nfs_server }}:/mnt/pool0/media/music", mount: "/home/media/Music", fstype: "nfs4", opts: "_netdev,auto" }
      - { remote: "{{ nfs_server }}:/mnt/pool1/media/Movies", mount: "/home/media/Movies", fstype: "nfs4", opts: "_netdev,auto" }
      - { remote: "{{ nfs_server }}:/mnt/pool0/media/audiobooks", mount: "/home/media/Books", fstype: "nfs4", opts: "_netdev,auto" }
  serial: 1
  max_fail_percentage: 100
  become: true
  remote_user: root
  tasks:
    - name: Ensure directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      with_items:
        - /home/shared
        - /home/media/TV
        - /home/media/Music
        - /home/media/Movies
        - /home/media/Books

    - name: makesure multipath.conf exists
      copy:
        content: ""
        dest: /etc/multipath.conf
        force: no
        backup: yes
      ignore_errors: yes

    - name: Manage /etc/multipath.conf
      blockinfile:
        path: /etc/multipath.conf
        block: |
          defaults {
              user_friendly_names yes
              find_multipaths yes
          }

    - name: Check if packages are installed
      shell: dpkg -l {{ item }} | grep -q "^ii" && echo "installed" || echo "not_installed"
      register: package_checks
      loop:
        - nfs-common
        - avahi-daemon
        - open-iscsi
        - lsscsi
        - sg3-utils
        - multipath-tools
        - scsitools
      changed_when: false
      failed_when: false

    - name: Install Apt packages
      apt:
        name: "{{ item.item }}"
        state: present
      loop: "{{ package_checks.results }}"
      when: item.stdout == "not_installed"

    - name: Check if nfs-kernel-server is installed (for NFS server)
      shell: dpkg -l nfs-kernel-server | grep -q "^ii" && echo "installed" || echo "not_installed"
      register: nfs_server_check
      changed_when: false
      failed_when: false
      when: '"lan-client-server" in group_names'

    - name: Install nfs-kernel-server on head node
      apt:
        name: nfs-kernel-server
        state: present
      when: 
        - '"lan-client-server" in group_names'
        - nfs_server_check.stdout == "not_installed"

    - name: Ensure NFS export directories exist on head node
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /mnt/pool0/share
        - /mnt/pool1/media/TV
        - /mnt/pool0/media/music
        - /mnt/pool1/media/Movies
        - /mnt/pool0/media/audiobooks
      when: '"lan-client-server" in group_names'

    - name: Configure NFS exports on head node
      lineinfile:
        path: /etc/exports
        line: "{{ item.path }} {{ item.network }}(rw,sync,no_subtree_check,no_root_squash)"
        regexp: "^{{ item.path }} "
        state: present
      loop:
        - { path: "/mnt/pool0/share", network: "192.168.128.0/24" }
        - { path: "/mnt/pool1/media/TV", network: "192.168.128.0/24" }
        - { path: "/mnt/pool0/media/music", network: "192.168.128.0/24" }
        - { path: "/mnt/pool1/media/Movies", network: "192.168.128.0/24" }
        - { path: "/mnt/pool0/media/audiobooks", network: "192.168.128.0/24" }
      when: '"lan-client-server" in group_names'
      notify: Restart NFS Server

    - name: Export NFS shares
      command: exportfs -ra
      when: '"lan-client-server" in group_names'
      changed_when: true

    - name: Enable and start NFS server
      systemd:
        name: nfs-kernel-server
        enabled: yes
        state: started
      when: '"lan-client-server" in group_names'

    - name: Ensure NFS mounts are present in fstab (non-blocking)
      mount:
        src: "{{ item.remote }}"
        path: "{{ item.mount }}"
        fstype: "{{ item.fstype | default('nfs4') }}"
        opts: "{{ item.opts | default('_netdev,auto') }}"
        state: present
      loop: "{{ nfs_exports }}"

    - name: Attempt to mount NFS exports if reachable
      mount:
        src: "{{ item.remote }}"
        path: "{{ item.mount }}"
        fstype: "{{ item.fstype | default('nfs4') }}"
        opts: "{{ item.opts | default('_netdev,auto') }}"
        state: mounted
      loop: "{{ nfs_exports }}"
      ignore_errors: true
    - name: Ensure specific /etc/fstab entries
      lineinfile:
        path: /etc/fstab
        line: "{{ item }}"
        insertafter: EOF
      with_items:
        - "192.168.128.111:/mnt/pool0/share              /home/shared         nfs4    _netdev,auto  0  1"
        - "192.168.128.111:/mnt/pool1/media/TV           /home/media/TV       nfs4    _netdev,auto  0  1"
        - "192.168.128.111:/mnt/pool0/media/music        /home/media/Music    nfs4    _netdev,auto  0  1"
        - "192.168.128.111:/mnt/pool1/media/Movies       /home/media/Movies   nfs4    _netdev,auto  0  1"
        - "192.168.128.111:/mnt/pool0/media/audiobooks   /home/media/Books    nfs4    _netdev,auto  0  1"

    - name: Enable services
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      with_items:
        - open-iscsi
        - multipath-tools

  handlers:
    - name: Restart NFS Server
      systemd:
        name: nfs-kernel-server
        state: restarted

- name: Update configuration, execute command, and install packages
  hosts: 
    - lan-client-server
    - lan-client
    - wan-clients
    - cheese
  serial: 1
  max_fail_percentage: 100
  become: true
  vars:
    head_node_ip: "{{ lookup('env', 'HEAD_NODE_IP') | default('192.168.128.111', true) }}"
    nomad_server_ips_value: "{{ nomad_server_ips | default(lookup('env', 'NOMAD_SERVER_IPS') | default(head_node_ip, true), true) }}"
    nomad_server_ips_list: "{{ (nomad_server_ips_value | string).split(',') }}"
  remote_user: root
  #roles:
  #  - role: artis3n.tailscale
  #    vars:
  #      # Example pulling the API key from the env vars on the host running Ansible
  #      tailscale_authkey: "{{ lookup('env', 'NOMAD_VAR_tailscale_auth') }}"
  #      tailscale_args: "{% if 'wan-clients' in group_names %}--accept-routes=true{% else %}--accept-routes=false{% endif %}"
  tasks:
    - name: Ensure directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      with_items:
        - /var/lib/nomad
        - /var/lib/consul
        - /etc/nomad.d
        - /etc/consul.d

    - name: Manage systemd service file nomad
      copy:
        src: "{{ playbook_dir }}/../configs/nomad.service"
        dest: /lib/systemd/system/nomad.service
      notify: Reload systemd

    - name: Manage systemd service file consul
      copy:
        src: "{{ playbook_dir }}/../configs/consul.service"
        dest: /lib/systemd/system/consul.service
      notify: Reload systemd

    - name: manage nomad config
      template:
        src: "{{ playbook_dir }}/../configs/nomad.hcl.j2"
        dest: /etc/nomad.d/nomad.hcl
      notify: Restart Service

    - name: manage consul config
      template:
        src: "{{ playbook_dir }}/../configs/consul.hcl.j2"
        dest: /etc/consul.d/server.hcl

    - name: Add HashiCorp APT repository key
      apt_key:
        url: https://apt.releases.hashicorp.com/gpg
        state: present
        validate_certs: no
        keyring: /usr/share/keyrings/hashicorp-archive-keyring.gpg

    - name: Configure HashiCorp APT repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"

    - name: Check if nomad is installed
      shell: dpkg -l nomad | grep -q "^ii" && echo "installed" || echo "not_installed"
      register: nomad_check
      changed_when: false
      failed_when: false

    - name: Check if consul is installed
      shell: dpkg -l consul | grep -q "^ii" && echo "installed" || echo "not_installed"
      register: consul_check
      changed_when: false
      failed_when: false

    - name: Install nomad if not installed
      apt:
        name: nomad=1.10.4-1
        dpkg_options: 'force-confdef,force-confold'
        update_cache: true
        state: present
      when: nomad_check.stdout == "not_installed"

    - name: Install consul if not installed
      apt:
        name: consul=1.19.1-1
        dpkg_options: 'force-confdef,force-confold'
        update_cache: true
        state: present
      when: consul_check.stdout == "not_installed"

    - name: Modify sysctl entry for net.ipv4.ip_nonlocal_bind
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
      with_items:
        - { name: "net.ipv4.ip_nonlocal_bind", value: "1" }
        - { name: "net.ipv4.conf.all.forwarding", value: "1" }
      notify: Apply Sysctl Changes

    - name: Enable services
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      with_items:
        - nomad
        - consul
        - tailscaled

  handlers:
    - name: Restart Service
      service:
        name: nomad
        state: restarted

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Apply Sysctl Changes
      command: sysctl -p /etc/sysctl.conf

- name: Install and configure Tailscale 
  hosts:
    - all
  become: yes
  remote_user: root
  serial: 1
  max_fail_percentage: 100
  gather_facts: yes

  vars:
    # Read authkey from environment variable; default to 'MISSING' if not set
    tailscale_auth_key: "{{ lookup('env', 'NOMAD_VAR_tailscale_auth') | default('MISSING') }}"
    # Optionally customize your Tailscale hostname
    tailscale_hostname: "{{ inventory_hostname }}"

  tasks:
    - name: Download Tailscale GPG key via curl
      shell: >
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg
        | tee /usr/share/keyrings/tailscale-archive-keyring.gpg
        >/dev/null
      changed_when: true

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Configure Tailscale apt repository
      copy:
        dest: /etc/apt/sources.list.d/tailscale.list
        content: |
          deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg arch=amd64] https://pkgs.tailscale.com/stable/ubuntu/ noble main

    - name: Update apt cache (after adding Tailscale repo)
      apt:
        update_cache: yes

    - name: Check if tailscale is installed
      shell: dpkg -l tailscale | grep -q "^ii" && echo "installed" || echo "not_installed"
      register: tailscale_check
      changed_when: false
      failed_when: false

    - name: Install Tailscale if not installed
      apt:
        name: tailscale
        state: present
      when: tailscale_check.stdout == "not_installed"

    - name: Enable and start tailscaled service
      service:
        name: tailscaled
        state: started
        enabled: yes

    - name: Bring Tailscale interface up using authkey
      # "command" used because there's no official Ansible module for "tailscale up".
      # This is not strictly idempotent; see notes below for advanced usage.
      command: >
        tailscale up
        --authkey={{ tailscale_auth_key }}
        --hostname={{ tailscale_hostname }}
        --reset
      register: tailscale_up
      changed_when: "'Success' in tailscale_up.stdout or 'Success' in tailscale_up.stderr or tailscale_up.rc == 0"

    - name: Show tailscale status
      command: tailscale status
      register: tailscale_status
      changed_when: false

    - debug:
        var: tailscale_status.stdout
